<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå GATE</title>

  <!-- ‚úÖ Tailwind CDN (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ; warning ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á production ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Athiti:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: '#f97316' },
            secondary: { DEFAULT: '#9333ea' },
          },
          boxShadow: {
            'soft-xl': '0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.02)',
            'glow-primary': '0 4px 20px -2px rgba(249, 115, 22, 0.45)',
            'glow-secondary': '0 4px 20px -2px rgba(147, 51, 234, 0.45)',
          }
        }
      }
    }
    // ‚úÖ Alias: ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£"
    function getQueueListByLevel(level) {
      return getQueueByLevel(level);
    }

    // ‚úÖ ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£")
    function openStudentQuickView(studentId) {
      const s = studentsData.find(x => String(x.national_id) === String(studentId));
      if (!s) return;

      const count = Object.keys(getInterviewScores(s) || {}).length;
      const final = calcInterviewFinal(s);

      showModal(`
        <div class="p-6 md:p-10">
          <div class="flex items-start justify-between gap-4 mb-6">
            <div class="min-w-0">
              <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 truncate">${s.name}</h2>
              <p class="text-gray-600 font-medium truncate">${s.current_school || '-'} <span class="mx-2 text-gray-300">‚Ä¢</span> #${s.interview_order || '-'}</p>
            </div>
            ${getLevelBadge(s.level)}
          </div>

          <div class="bg-gradient-to-r from-orange-50 to-white border-2 border-orange-100 rounded-[2rem] p-6 mb-6">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <div class="bg-white rounded-2xl border border-gray-100 p-4 text-center"><p class="text-xs text-gray-500 font-bold mb-1">‡∏Ñ‡∏ì‡∏¥‡∏ï</p><p class="text-xl font-extrabold">${s.math_score || 0}</p></div>
              <div class="bg-white rounded-2xl border border-gray-100 p-4 text-center"><p class="text-xs text-gray-500 font-bold mb-1">‡∏ß‡∏¥‡∏ó‡∏¢‡πå</p><p class="text-xl font-extrabold">${s.science_score || 0}</p></div>
              <div class="bg-white rounded-2xl border border-gray-100 p-4 text-center"><p class="text-xs text-gray-500 font-bold mb-1">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</p><p class="text-xl font-extrabold">${s.english_score || 0}</p></div>
              <div class="bg-orange-500 text-white rounded-2xl p-4 text-center"><p class="text-xs opacity-90 font-bold mb-1">‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</p><p class="text-2xl font-extrabold">${s.total_score || 0}</p></div>
            </div>
          </div>

          ${s.ability ? `
            <div class="bg-purple-50 border-2 border-purple-100 rounded-[2rem] p-6 mb-6">
              <p class="text-sm font-extrabold text-purple-700 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
              <p class="text-gray-900 font-medium break-words">${s.ability}</p>
            </div>
          ` : ''}

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <div class="bg-white border border-gray-100 rounded-2xl p-5">
              <p class="text-sm font-bold text-gray-700">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ)</p>
              <p class="text-3xl font-extrabold text-orange-600 mt-1">${Math.round(final.total100 * 100) / 100}</p>
            </div>
            <div class="bg-white border border-gray-100 rounded-2xl p-5">
              <p class="text-sm font-bold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
              <p class="text-3xl font-extrabold text-gray-900 mt-1">${count}/${TOTAL_JUDGES}</p>
            </div>
          </div>

          ${s.audio_file ? `
            <a href="${s.audio_file}" target="_blank" class="btn-secondary w-full py-3 rounded-xl font-bold flex items-center justify-center mb-4">
              ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß
            </a>
          ` : ''}

          <button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary w-full px-6 py-4 rounded-2xl font-bold text-xl text-white shadow-glow-primary">‡∏õ‡∏¥‡∏î</button>
        </div>
      `);
    }
;
  </script>

  <style>
    body {
      font-family: 'Athiti', sans-serif;
      background-color: #fff7ed;
      background-image: radial-gradient(#f97316 0.5px, transparent 0.5px), radial-gradient(#f97316 0.5px, #fff7ed 0.5px);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
    }

    .main-bg-gradient {
      background: radial-gradient(at left top, rgba(255,237,213,0.7) 0%, rgba(255,255,255,0) 45%),
                  radial-gradient(at right bottom, rgba(243,232,255,0.7) 0%, rgba(255,255,255,0) 45%);
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.86);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.35);
    }

    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
    }

    .spinner { border: 3px solid #f3f4f6; border-top: 3px solid #f97316; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .input-field{
      width:100%;
      padding:0.75rem 1rem;
      border:2px solid #e5e7eb;
      border-radius:1rem;
      transition:all .2s ease;
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(8px);
      outline:none;
    }
    .input-field:focus{
      border-color:#f97316;
      box-shadow:0 0 0 4px rgba(249,115,22,.15);
      background:#fff;
    }

    .btn-primary {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      transition: all 0.25s ease;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 10px 20px -10px rgba(249, 115, 22, 0.6); }
    .btn-primary:active { transform: translateY(0); }

    .btn-secondary {
      background: white;
      border: 2px solid #f97316;
      color: #f97316;
      transition: all 0.25s ease;
    }
    .btn-secondary:hover { background: #fff7ed; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15); }

    .text-gradient-primary {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .text-gradient-secondary {
      background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
  </style>
</head>

<body class="h-full w-full m-0 p-0">
  <main class="h-full w-full overflow-auto main-bg-gradient">
    <div id="app" class="min-h-full w-full"></div>
  </main>

  <script>
    // ============================================================
    // ‚úÖ OPTIONAL SDK LOADER: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå _sdk ‡∏à‡∏∞‡πÑ‡∏°‡πà error 404/MIME ‡∏≠‡∏µ‡∏Å
    // ============================================================
    (async function loadLocalSDKsSafely() {
      const files = ['./_sdk/data_sdk.js', './_sdk/element_sdk.js'];
      for (const src of files) {
        try {
          const r = await fetch(src, { cache: 'no-store' });
          const ct = (r.headers.get('content-type') || '').toLowerCase();
          if (!r.ok) continue;
          // ‡∏ö‡∏≤‡∏á server ‡∏™‡πà‡∏á text/html (404 page) -> ‡∏Ç‡πâ‡∏≤‡∏°
          if (!(ct.includes('javascript') || ct.includes('ecmascript') || src.endsWith('.js'))) {
            continue;
          }
          const s = document.createElement('script');
          s.src = src;
          s.async = false;
          document.head.appendChild(s);
        } catch (_) {}
      }
    })();
  </script>

  <script>
    // ==========================================
    // üî¥ ‡πÉ‡∏™‡πà URL Web App (/exec) ‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß
    const API_URL = "/api/gas";
    // ==========================================

    // =====================
    // Global State
    // =====================
    let currentUser = null;
    let studentsData = [];
    let committeesData = [];
    let allData = [];
    let queueState = { junior: null, senior: null }; // ‚úÖ ‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Config
    let autoRefreshInterval = null;

    // file upload state
    let uploadedAudio = null; // {fileData, mimeType, fileName}

    const AUTO_REFRESH_MS = 5000;
    const TOTAL_JUDGES = 8; // ‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ 8 ‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏∏‡∏ì

    // =====================
    // Session (‡∏à‡∏≥‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≠‡∏ô‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î)
    // =====================
    function saveSession(session) { localStorage.setItem('gate_session', JSON.stringify(session)); }
    function loadSession() { try { return JSON.parse(localStorage.getItem('gate_session') || 'null'); } catch { return null; } }
    function clearSession() { localStorage.removeItem('gate_session'); }

    // ============================================================
    // ‚úÖ Modal Utilities (Responsive: Mobile-first, no overflow)
    // ============================================================
    function showModal(innerHtml) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay fixed inset-0 z-[9999] flex items-end sm:items-center justify-center';

      overlay.innerHTML = `
        <div class="absolute inset-0" onclick="closeModal(this.parentElement)"></div>

        <div class="relative glass-effect w-full sm:w-[96vw] sm:max-w-4xl
                    h-[92vh] sm:h-auto sm:max-h-[92vh]
                    rounded-t-[2rem] sm:rounded-[2rem]
                    shadow-soft-xl overflow-hidden">

          <button class="absolute top-3 right-3 sm:top-4 sm:right-4 z-10
                        w-10 h-10 rounded-xl bg-white/85 hover:bg-white
                        border border-gray-200 flex items-center justify-center"
                  onclick="closeModal(this.closest('.modal-overlay'))"
                  aria-label="Close">‚úï</button>

          <div class="h-full max-h-[92vh] overflow-y-auto overscroll-contain p-5 sm:p-8">
            ${innerHtml}
          </div>
        </div>
      `;

      document.body.appendChild(overlay);
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      return overlay;
    }

    function closeModal(overlayEl) {
      if (!overlayEl) return;
      overlayEl.remove();
      if (!document.querySelector('.modal-overlay')) {
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
      }
    }

    function showLoadingModal(text) {
      return showModal(`
        <div class="py-10 text-center">
          <div class="spinner mx-auto mb-6"></div>
          <p class="text-lg font-bold text-gray-800">${text || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'}</p>
          <p class="text-sm text-gray-500 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>
        </div>
      `);
    }

    // ============================================================
    // ‚úÖ Fetch helpers
    // ============================================================
    async function fetchJSON(url, options) {
      const res = await fetch(url, options);
      const txt = await res.text();
      try { return JSON.parse(txt); } catch (_) { return txt; }
    }

    function normalizeAllData(data) {
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.allData)) return data.allData;
      if (data && Array.isArray(data.data)) return data.data;
      if (data && Array.isArray(data.students)) return data.students;
      return [];
    }

    function toBool(v) {
      if (typeof v === 'boolean') return v;
      const s = String(v ?? '').trim().toLowerCase();
      if (s === 'true' || s === '1' || s === 'yes') return true;
      if (s === 'false' || s === '0' || s === 'no' || s === '') return false;
      return !!v;
    }

    function getInterviewScores(student) {
      const obj = student?.interview_scores || student?.scores || {};
      return (obj && typeof obj === 'object') ? obj : {};
    }

    function hasCommitteeScored(student, committeeUsername) {
      const scores = getInterviewScores(student);
      return scores && committeeUsername && scores[committeeUsername] !== undefined;
    }

    function num(v, fallback = 0) {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    // ============================================================
    // ‚úÖ Queue helpers (‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≤‡∏Å Config)
    // ============================================================
    function getQueueNow(level) {
      if (level === 'junior') return queueState.junior;
      return queueState.senior;
    }

    function getActiveQueueStudents(level) {
      return studentsData
        .filter(s => s.level === level && s.confirmed && !s.is_skipped)
        .sort((a,b) => num(a.interview_order, 999999) - num(b.interview_order, 999999));
    }

    // ‡πÑ‡∏î‡πâ "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á (Config) ‡πÅ‡∏ö‡∏ö robust: ‡∏´‡∏≤ order >= current
    function getCurrentStudentByLevel(level) {
      const list = getActiveQueueStudents(level);
      if (!list.length) return null;
      const cur = num(getQueueNow(level), 0);
      if (!cur) return list[0];
      return list.find(s => num(s.interview_order, 0) >= cur) || null;
    }

    // ============================================================
    // ‚úÖ Init + Load data
    // ============================================================
    async function initAPI(silent = false) {
      const loading = !silent ? showLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...') : null;
      try {
        const data = await fetchJSON(API_URL + '?t=' + Date.now());
        onDataLoaded(data, { silent, loading });
      } catch (error) {
        onDataError(error, { silent, loading });
      }
    }

    function onDataLoaded(data, ctx = {}) {
      if (ctx.loading) closeModal(ctx.loading);

      allData = normalizeAllData(data);

      // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô config (‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á) ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å allData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏õ‡∏ô‡∏Å‡∏±‡∏ö student/user
      const cfg = allData.find(x => x && x.user_type === 'config');
      if (cfg) {
        queueState.junior = num(cfg.current_junior, 0);
        queueState.senior = num(cfg.current_senior, 0);
        allData = allData.filter(x => !(x && x.user_type === 'config'));
      }

      studentsData = allData
        .filter(row => !row.user_type || row.user_type === 'student')
        .map(s => ({ ...s, confirmed: toBool(s.confirmed), is_skipped: toBool(s.is_skipped) }));

      committeesData = allData.filter(row => row.user_type === 'committee' || row.user_type === 'admin');

      // ‚úÖ sync currentUser ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏´‡πâ‡∏≤‡∏° rebuild ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö)
      if (currentUser) {
        if (currentUser.user_type === 'student') {
          const updated = studentsData.find(u => String(u.national_id) === String(currentUser.national_id));
          if (updated) currentUser = { ...updated, user_type: 'student' };
        } else {
          const updated = committeesData.find(u => String(u.username) === String(currentUser.username));
          if (updated) currentUser = { ...updated };
        }
      }

      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô silent refresh -> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö)
      if (ctx.silent) {
        updateLiveUI();
        return;
      }

      // ‚úÖ render ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      if (currentUser) renderCurrentView();
      else renderLoginPage();
    }

    function onDataError(error, ctx = {}) {
      if (ctx.loading) closeModal(ctx.loading);
      console.error(error);

      // ‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏≠‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ "Failed to fetch" ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
      const hint = `
‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ Web App Deploy ‡πÄ‡∏õ‡πá‡∏ô "Anyone" ‡∏´‡∏£‡∏∑‡∏≠ "Anyone with the link"
‚Ä¢ ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå API_URL ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô JSON (‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ login/permission ‡∏à‡∏∞ fetch ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ URL ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà /dev)
      `.trim();

      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + (error?.message || error) + "\n\n" + hint);
      if (!ctx.silent) renderLoginPage();
    }

    // ============================================================
    // ‚úÖ SaveData -> POST {id,data} ‡πÑ‡∏õ Apps Script (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏µ‡∏ï‡∏à‡∏£‡∏¥‡∏á)
    // ============================================================
    async function saveData(rowId, dataToUpdate) {
      const id = String(rowId || '').trim();
      if (!id) throw new Error("Missing rowId");

      // optimistic update (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ù‡∏±‡πà‡∏á UI)
      const idx = studentsData.findIndex(d => String(d.national_id) === id || String(d.student_id) === id || String(d._id) === id);
      if (idx !== -1) studentsData[idx] = { ...studentsData[idx], ...dataToUpdate };
      if (currentUser && currentUser.user_type === 'student' && String(currentUser.national_id) === id) {
        currentUser = { ...currentUser, ...dataToUpdate };
      }

      const res = await fetchJSON(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ id: id, data: dataToUpdate })
      });
      if (res && res.status === 'error') throw new Error(res.message || 'update error');
      return res;
    }

    // ============================================================
    // ‚úÖ Queue API (‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á)
    // ============================================================
    async function queueNext(level) {
      return await fetchJSON(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'queueNext', level })
      });
    }
    async function queueSkip(level) {
      return await fetchJSON(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'queueSkip', level })
      });
    }

    // ============================================================
    // ‚úÖ Auto refresh (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡∏à‡∏£‡∏¥‡∏á) - ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
    // ============================================================
    function startAutoRefresh() {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval = setInterval(() => initAPI(true), AUTO_REFRESH_MS);
    }
    function stopAutoRefresh() {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }

    // ============================================================
    // UI Helpers
    // ============================================================
    const defaultConfig = {
      system_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå',
      school_name: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏© (GATE)',
    };

    function getLevelBadge(level) {
      if (level === 'junior') {
        return `<span class="inline-flex items-center px-4 py-1.5 rounded-full text-sm font-semibold bg-purple-100 text-purple-700 border border-purple-200 shadow-sm">‡∏°.‡∏ï‡πâ‡∏ô</span>`;
      }
      return `<span class="inline-flex items-center px-4 py-1.5 rounded-full text-sm font-semibold bg-orange-100 text-orange-700 border border-orange-200 shadow-sm">‡∏°.‡∏õ‡∏•‡∏≤‡∏¢</span>`;
    }

    // ============================================================
    // Login Page
    // ============================================================
    function renderLoginPage() {
      stopAutoRefresh();
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;

      document.getElementById('app').innerHTML = `
        <div class="min-h-full flex items-center justify-center p-4 py-12 relative overflow-hidden">
          <div class="glass-effect rounded-[2.5rem] shadow-soft-xl p-8 md:p-12 max-w-[520px] w-full relative z-10">
            <div class="text-center mb-10">
              <div class="mx-auto mb-6 flex items-center justify-center">
                <img src="https://img5.pic.in.th/file/secure-sv1/LOGO-SAPA-1.png" alt="LOGO" class="h-24 w-auto object-contain"/>
              </div>
              <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-3 tracking-tight leading-tight">
                ${config.system_title || defaultConfig.system_title}
              </h1>
              <div class="inline-block mt-3 px-4 py-1 bg-orange-50 rounded-full border border-orange-100">
                <p class="text-sm text-orange-700 font-semibold">${config.school_name || defaultConfig.school_name}</p>
              </div>
            </div>

            <div class="space-y-8">
              <div class="bg-gradient-to-br from-orange-50 to-white/50 border-2 border-orange-100 rounded-3xl p-6 md:p-8 shadow-sm">
                <h2 class="text-xl font-bold text-gray-900 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <div class="space-y-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2 ml-1">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                  <input type="text" id="nationalId" maxlength="13" inputmode="numeric" pattern="[0-9]*"
                    class="input-field text-lg placeholder:text-gray-400"
                    placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å"/>
                  <button onclick="loginStudent()" class="btn-primary w-full text-white px-6 py-4 rounded-2xl font-bold text-lg shadow-glow-primary">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                  </button>
                </div>
              </div>

              <div class="text-center">
                <button onclick="toggleCommitteeLogin()" class="text-sm text-gray-500 hover:text-orange-600 font-medium underline-offset-4 hover:underline transition-all">
                  ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£ / ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
                </button>
              </div>

              <div id="committeeLoginSection" class="hidden bg-white/50 border-2 border-gray-100 rounded-3xl p-6 shadow-sm">
                <h2 class="text-lg font-bold text-gray-800 mb-4">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£ / Admin</h2>
                <div class="space-y-3">
                  <input type="text" id="username" class="input-field text-lg placeholder:text-gray-400" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"/>
                  <input type="password" id="password" class="input-field text-lg placeholder:text-gray-400" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"/>
                  <button onclick="loginCommittee()" class="btn-secondary w-full mt-2 px-6 py-3 rounded-xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
              </div>

              <div class="text-xs text-gray-400 text-center pt-2">
                * ‡∏ñ‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ <code>_sdk</code> ‡∏à‡∏∞‡πÑ‡∏°‡πà error ‡∏≠‡∏µ‡∏Å‡πÅ‡∏•‡πâ‡∏ß
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function toggleCommitteeLogin() {
      const section = document.getElementById('committeeLoginSection');
      section.classList.toggle('hidden');
    }

    // ============================================================
    // Login Functions
    // ============================================================
    function loginStudent() {
      const nationalId = document.getElementById('nationalId').value.trim();
      if (nationalId.length !== 13) {
        showModal(`<div class="p-8 text-center"><p class="text-gray-800 font-bold text-xl mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p><p class="text-gray-600 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å</p><button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary text-white px-8 py-3 rounded-xl font-medium">‡∏ï‡∏Å‡∏•‡∏á</button></div>`);
        return;
      }

      const student = studentsData.find(s => String(s.national_id).trim() === nationalId);
      if (!student) {
        showModal(`<div class="p-8 text-center"><p class="text-gray-800 font-bold text-xl mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p><p class="text-gray-600 mb-6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p><button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary text-white px-8 py-3 rounded-xl font-medium">‡∏ï‡∏Å‡∏•‡∏á</button></div>`);
        return;
      }

      currentUser = { ...student, user_type: 'student' };
      saveSession({ type: 'student', id: currentUser.national_id });

      if (!currentUser.confirmed) showConfirmationDialog(currentUser);
      else renderStudentDashboard();
    }

    function loginCommittee() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      const user = committeesData.find(c => String(c.username) === username && String(c.password) === password);
      if (!user) { alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }

      currentUser = user;
      saveSession({ type: 'committee', username, password });

      if (user.user_type === 'admin') renderAdminDashboard();
      else renderCommitteeDashboard();
    }

    // ============================================================
    // Student Confirmation Dialog
    // ============================================================
    function showConfirmationDialog(student) {
      showModal(`
        <div class="p-6 md:p-10">
          <div class="text-center mb-6">
            <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå</h2>
            <p class="text-gray-600">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô GATE</p>
          </div>

          <div class="bg-white border-2 border-gray-100 rounded-[2rem] p-6 mb-6 shadow-sm">
            <div class="flex items-center gap-4 mb-4">
              ${getLevelBadge(student.level)}
              <h3 class="text-xl font-bold text-gray-900">${student.name}</h3>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-base">
              <div class="bg-gray-50 p-4 rounded-2xl">
                <p class="text-sm text-gray-500 font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö</p>
                <p class="font-bold text-gray-800">${student.exam_number || '-'}</p>
              </div>
              <div class="bg-gray-50 p-4 rounded-2xl">
                <p class="text-sm text-gray-500 font-medium mb-1">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                <p class="font-medium text-gray-800">${student.current_school || '-'}</p>
              </div>
            </div>
          </div>

          <button onclick="showAbilityForm()" class="btn-primary w-full text-white px-6 py-4 rounded-2xl font-bold text-lg shadow-glow-primary">
            ‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
          </button>
        </div>
      `);
    }

    // ============================================================
    // Ability Form + Upload Audio
    // ============================================================
    function showAbilityForm() {
      document.querySelectorAll('.modal-overlay').forEach(m => closeModal(m));
      uploadedAudio = null;

      showModal(`
        <div class="p-6 md:p-10">
          <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 mb-6">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h2>
          <form id="abilityForm" class="space-y-8">
            <div>
              <label class="block text-lg font-bold text-gray-800 mb-3">
                ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô <span class="text-orange-500">*</span>
              </label>
              <textarea id="ability" required rows="5"
                class="input-field resize-none text-lg placeholder:text-gray-400"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£, ‡∏î‡∏ô‡∏ï‡∏£‡∏µ, ‡∏Å‡∏µ‡∏¨‡∏≤, ‡∏®‡∏¥‡∏•‡∏õ‡∏∞, ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à..."></textarea>
            </div>

            <div>
              <label class="block text-lg font-bold text-gray-800 mb-3">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <div class="border-2 border-dashed border-gray-200 rounded-[2rem] p-8 text-center hover:border-orange-400 hover:bg-orange-50 transition-all cursor-pointer"
                onclick="document.getElementById('audioFile').click()">
                <p class="text-lg font-medium text-gray-700 mb-1">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
                <p class="text-sm text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö audio/* (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB)</p>
              </div>
              <input type="file" id="audioFile" accept="audio/*" class="hidden" onchange="handleFileUpload(this)">
              <div id="uploadStatus" class="mt-4"></div>
            </div>

            <div class="flex gap-4 pt-2">
              <button type="button" onclick="cancelAbilityForm()" class="btn-secondary flex-1 px-6 py-4 rounded-2xl font-bold text-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="btn-primary flex-1 text-white px-6 py-4 rounded-2xl font-bold text-lg shadow-glow-primary">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
          </form>
        </div>
      `);

      document.getElementById('abilityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitAbilityForm();
      });
    }

    function handleFileUpload(input) {
      if (!input.files || !input.files[0]) return;
      const file = input.files[0];
      const statusDiv = document.getElementById('uploadStatus');

      statusDiv.innerHTML = `<div class="bg-blue-50 border border-blue-100 rounded-2xl p-4 flex items-center gap-4">
        <div class="spinner w-6 h-6 border-2"></div>
        <span class="text-blue-800 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå ${file.name}...</span>
      </div>`;

      if (file.size > 10 * 1024 * 1024) {
        statusDiv.innerHTML = `<div class="bg-red-50 border border-red-100 rounded-2xl p-4"><p class="font-bold text-red-700">‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB</p></div>`;
        input.value = '';
        uploadedAudio = null;
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        const base64 = String(reader.result).split(',')[1];
        uploadedAudio = { fileData: base64, mimeType: file.type || "application/octet-stream", fileName: file.name || "audio" };
        statusDiv.innerHTML = `<div class="bg-green-50 border border-green-100 rounded-2xl p-4">
          <p class="font-bold text-green-800">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</p>
          <p class="text-sm text-green-600 truncate">${file.name}</p>
        </div>`;
      };
      reader.onerror = () => {
        statusDiv.innerHTML = `<div class="bg-red-50 border border-red-100 rounded-2xl p-4"><p class="font-bold text-red-700">‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p></div>`;
        uploadedAudio = null;
      };
      reader.readAsDataURL(file);
    }

    function cancelAbilityForm() {
      document.querySelectorAll('.modal-overlay').forEach(m => closeModal(m));
      showConfirmationDialog(currentUser);
    }

    async function submitAbilityForm() {
      const ability = document.getElementById('ability').value.trim();
      if (!ability) {
        showModal(`<div class="p-8 text-center"><p class="text-red-600 font-bold text-xl mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©</p><button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary text-white px-8 py-3 rounded-xl font-medium">‡∏ï‡∏Å‡∏•‡∏á</button></div>`);
        return;
      }

      const loadingModal = showLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

      const patch = { ability, confirmed: true, status: '‡∏£‡∏≠‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå' };
      if (uploadedAudio) {
        patch.fileData = uploadedAudio.fileData;
        patch.mimeType = uploadedAudio.mimeType;
        patch.fileName = uploadedAudio.fileName;
      }

      try {
        await saveData(currentUser.national_id, patch);
        currentUser = { ...currentUser, ...patch };

        closeModal(loadingModal);
        document.querySelectorAll('.modal-overlay').forEach(m => closeModal(m));

        showModal(`
          <div class="p-8 text-center">
            <h3 class="text-2xl font-extrabold text-green-600 mb-3">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
            <p class="text-gray-600 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
            <button onclick="confirmAndGoToDashboard()" class="btn-primary text-white px-10 py-4 rounded-2xl font-bold text-lg shadow-glow-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
          </div>
        `);
      } catch (e) {
        closeModal(loadingModal);
        showModal(`<div class="p-8 text-center">
          <p class="text-red-600 font-bold text-xl mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
          <p class="text-gray-600 mb-6">${e?.message || e}</p>
          <button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary text-white px-8 py-3 rounded-xl font-medium">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>`);
      }
    }

    function confirmAndGoToDashboard() {
      document.querySelectorAll('.modal-overlay').forEach(m => closeModal(m));
      renderStudentDashboard();
    }

    // ============================================================
    // Live UI update (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≠‡∏ô auto refresh)
    // ============================================================
    function updateLiveUI() {
      const last = document.getElementById('liveLastSync');
      if (last) last.textContent = new Date().toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      const elJ = document.getElementById('liveCurrentJuniorQueue');
      const elS = document.getElementById('liveCurrentSeniorQueue');
      if (elJ) elJ.textContent = (queueState.junior ?? '-') || '-';
      if (elS) elS.textContent = (queueState.senior ?? '-') || '-';

      const stOrder = document.getElementById('liveMyOrder');
      const stTime  = document.getElementById('liveMyTime');
      const stStat  = document.getElementById('liveMyStatus');
      if (currentUser?.user_type === 'student') {
        if (stOrder) stOrder.textContent = currentUser.interview_order || '-';
        if (stTime)  stTime.textContent  = currentUser.interview_time || '-';
        if (stStat)  stStat.textContent  = currentUser.status || (currentUser.confirmed ? '‡∏£‡∏≠‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå' : '-');
      }

      // committee current student card
      if (currentUser?.user_type === 'committee') {
        const cur = getCurrentStudentByLevel(currentUser.level);
        const already = cur ? hasCommitteeScored(cur, currentUser.username) : false;

        const curName = document.getElementById('liveCommitteeCurrentName');
        const curOrder = document.getElementById('liveCommitteeCurrentOrder');
        const curSchool = document.getElementById('liveCommitteeCurrentSchool');
        const curExam = document.getElementById('liveCommitteeCurrentExam');
        const curAbility = document.getElementById('liveCommitteeCurrentAbility');
        const audioLink = document.getElementById('liveCommitteeAudioLink');
        const scoreBtn = document.getElementById('liveCommitteeScoreBtn');

        if (curName) curName.textContent = cur?.name || '-';
        if (curOrder) curOrder.textContent = cur?.interview_order || '-';
        if (curSchool) curSchool.textContent = cur?.current_school || '-';
        if (curExam) curExam.textContent = cur?.exam_number || '-';
        if (curAbility) curAbility.textContent = cur?.ability || (cur ? '-' : '-');

        if (audioLink) {
          if (cur?.audio_file) {
            audioLink.href = cur.audio_file;
            audioLink.classList.remove('opacity-60', 'pointer-events-none');
          } else {
            audioLink.href = '#';
            audioLink.classList.add('opacity-60', 'pointer-events-none');
          }
        }

        if (scoreBtn) {
          if (!cur || already) {
            scoreBtn.classList.add('opacity-60', 'pointer-events-none');
          } else {
            scoreBtn.classList.remove('opacity-60', 'pointer-events-none');
            scoreBtn.setAttribute('onclick', `openScoreForm('${cur.national_id}')`);
          }
        }

        // next list
        const nextBox = document.getElementById('liveCommitteeNextList');
        if (nextBox) {
          const queueList = getQueueByLevel(currentUser.level);
          const curIdx = cur ? queueList.findIndex(s => String(s.national_id) === String(cur.national_id)) : -1;
          const nextList = (curIdx >= 0 ? queueList.slice(curIdx + 1) : queueList).slice(0, 6);

          nextBox.innerHTML = nextList.length ? nextList.map(s => `
            <div class="bg-white border border-gray-100 rounded-2xl p-4 flex items-center justify-between gap-3">
              <div class="flex items-center gap-3 min-w-0">
                <div class="w-10 h-10 bg-purple-100 text-purple-700 rounded-xl flex items-center justify-center font-extrabold">${s.interview_order || '-'}</div>
                <div class="min-w-0">
                  <p class="font-bold text-gray-900 truncate">${s.name}</p>
                  <p class="text-xs text-gray-500 truncate">${s.current_school || '-'}</p>
                </div>
              </div>
              <button class="text-sm font-bold text-orange-600 hover:text-orange-700"
                      onclick="openStudentQuickView('${s.national_id}')">‡∏î‡∏π</button>
            </div>
          `).join('') : `<p class="text-sm text-gray-400 text-center py-6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>`;
        }

        // history (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ)
        renderCommitteeHistory();
      }

      // admin queue numbers
      const aj = document.getElementById('liveAdminJunior');
      const as = document.getElementById('liveAdminSenior');
      if (aj) aj.textContent = (queueState.junior ?? '-') || '-';
      if (as) as.textContent = (queueState.senior ?? '-') || '-';
    }

    // ============================================================
    // Student Dashboard
    // ============================================================
    function renderStudentDashboard() {
      startAutoRefresh();

      document.getElementById('app').innerHTML = `
        <div class="min-h-full p-4 md:p-8 pb-20">
          <div class="max-w-5xl mx-auto space-y-8">
            <div class="glass-effect rounded-[2.5rem] shadow-soft-xl p-6 md:p-8 flex flex-col md:flex-row items-center justify-between gap-6 relative overflow-hidden">
              <div class="flex items-center gap-6 w-full md:w-auto">
                <div class="flex items-center justify-center shrink-0 rotate-2">
                  <img src="https://img5.pic.in.th/file/secure-sv1/LOGO-SAPA-1.png" alt="LOGO" class="h-20 w-auto object-contain"/>
                </div>
                <div>
                  <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 mb-1">${currentUser.name}</h1>
                  <div class="flex items-center gap-3">
                    ${getLevelBadge(currentUser.level)}
                    <span class="text-gray-500 font-medium">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏≠‡∏ö: ${currentUser.exam_number || '-'}</span>
                  </div>
                </div>
              </div>
              <button onclick="logout()" class="btn-secondary px-6 py-3 rounded-xl text-sm font-bold shrink-0">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="glass-effect rounded-[2.5rem] shadow-soft-xl p-8 relative overflow-hidden">
                <h2 class="text-xl font-bold text-purple-800 mb-4">‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏°.‡∏ï‡πâ‡∏ô</h2>
                <div class="text-center">
                  <p id="liveCurrentJuniorQueue" class="text-6xl md:text-7xl font-extrabold text-gradient-secondary mb-2">${(queueState.junior ?? '-') || '-'}</p>
                  <p class="text-purple-600 font-medium inline-block bg-purple-100 px-4 py-1 rounded-full">‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á (Admin ‡∏Ñ‡∏∏‡∏°)</p>
                </div>
              </div>

              <div class="glass-effect rounded-[2.5rem] shadow-soft-xl p-8 relative overflow-hidden">
                <h2 class="text-xl font-bold text-orange-800 mb-4">‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏°.‡∏õ‡∏•‡∏≤‡∏¢</h2>
                <div class="text-center">
                  <p id="liveCurrentSeniorQueue" class="text-6xl md:text-7xl font-extrabold text-gradient-primary mb-2">${(queueState.senior ?? '-') || '-'}</p>
                  <p class="text-orange-600 font-medium inline-block bg-orange-100 px-4 py-1 rounded-full">‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á (Admin ‡∏Ñ‡∏∏‡∏°)</p>
                </div>
              </div>
            </div>

            <div class="glass-effect rounded-[2.5rem] shadow-soft-xl p-8">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                <button onclick="showStudentInfo()" class="text-orange-600 hover:text-orange-700 font-bold underline-offset-4 hover:underline">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              </div>

              <div class="bg-gradient-to-r from-orange-50 to-white border-2 border-orange-100 rounded-3xl p-6 flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-6">
                  <div class="w-24 h-24 bg-white rounded-2xl flex items-center justify-center shadow-sm border-2 border-orange-100">
                    <span id="liveMyOrder" class="text-4xl font-extrabold text-orange-500">${currentUser.interview_order || '-'}</span>
                  </div>
                  <div>
                    <p class="text-lg font-bold text-gray-900 mb-1">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    <p class="text-orange-600 font-medium bg-orange-100 px-3 py-1 rounded-lg inline-block">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì <span id="liveMyTime">${currentUser.interview_time || '-'}</span></p>
                  </div>
                </div>

                <div class="text-right md:text-left">
                  <p class="text-gray-500 font-medium mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                  <span class="inline-flex items-center px-5 py-2 rounded-full text-lg font-bold bg-green-100 text-green-700 border-2 border-green-200">
                    <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                    <span id="liveMyStatus">${currentUser.status || (currentUser.confirmed ? '‡∏£‡∏≠‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå' : '-')}</span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showStudentInfo() {
      const student = currentUser;
      showModal(`
        <div class="p-6 md:p-10">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
            ${getLevelBadge(student.level)}
          </div>

          <div class="bg-white border-2 border-gray-100 rounded-[2rem] p-6 mb-6 shadow-sm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-lg">
              <div><p class="text-gray-500 font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</p><p class="font-bold text-gray-900 text-xl">${student.name}</p></div>
              <div><p class="text-gray-500 font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö</p><p class="font-bold text-gray-900 text-xl">${student.exam_number || '-'}</p></div>
              <div class="md:col-span-2"><p class="text-gray-500 font-medium mb-1">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p><p class="font-bold text-gray-900 text-xl">${student.current_school || '-'}</p></div>
            </div>
          </div>

          ${student.ability ? `
            <h3 class="text-xl font-bold text-gray-900 mb-3">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©</h3>
            <div class="bg-purple-50 border-2 border-purple-100 rounded-[2rem] p-6 text-lg font-medium text-purple-900 mb-6">
              "${student.ability}"
            </div>
          ` : ''}

          ${student.audio_file ? `
            <a href="${student.audio_file}" target="_blank" class="btn-secondary w-full py-3 rounded-xl font-bold flex items-center justify-center mb-4">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß</a>
          ` : ''}

          <button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary w-full px-6 py-4 rounded-2xl font-bold text-lg text-white shadow-glow-primary">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
      `);
    }

    // ============================================================
    // Committee Dashboard
    // ============================================================
    function renderCommitteeDashboard() {
  startAutoRefresh();

  // queues (for header cards)
  const juniorQueue = studentsData
    .filter(s => s.level === 'junior' && s.confirmed && !s.is_skipped)
    .sort((a,b) => Number(a.interview_order||999999) - Number(b.interview_order||999999));
  const seniorQueue = studentsData
    .filter(s => s.level === 'senior' && s.confirmed && !s.is_skipped)
    .sort((a,b) => Number(a.interview_order||999999) - Number(b.interview_order||999999));

  const currentJuniorQueue = juniorQueue[0]?.interview_order ?? '-';
  const currentSeniorQueue = seniorQueue[0]?.interview_order ?? '-';

  const myLevel = currentUser.level || 'junior';
  const levelLabel = (myLevel === 'junior') ? '‡∏°.‡∏ï‡πâ‡∏ô' : '‡∏°.‡∏õ‡∏•‡∏≤‡∏¢';
  const levelColor = (myLevel === 'junior') ? 'purple' : 'orange';

  // list for this committee level
  const list = studentsData
    .filter(s => s.level === myLevel && s.confirmed)
    .sort((a,b) => Number(a.interview_order||999999) - Number(b.interview_order||999999));

  const statusPill = (s) => {
    const scored = hasCommitteeScored(s, currentUser.username);
    if (scored) {
      return `<span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-bold bg-green-100 text-green-700 border border-green-200">
        <span class="w-2 h-2 bg-green-500 rounded-full"></span> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      </span>`;
    }
    return `<span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-bold bg-gray-100 text-gray-600 border border-gray-200">
      <span class="w-2 h-2 bg-gray-400 rounded-full"></span> ‡∏£‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    </span>`;
  };

  const scoreBtn = (s) => {
    const scored = hasCommitteeScored(s, currentUser.username);
    if (scored) {
      return `<button class="px-4 py-2 rounded-xl font-bold text-sm bg-gray-200 text-gray-500 cursor-not-allowed" disabled>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>`;
    }
    return `<button onclick="openScoreForm('${s.national_id}')" class="btn-primary text-white px-4 py-2 rounded-xl font-bold text-sm shadow-glow-primary">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>`;
  };

  document.getElementById('app').innerHTML = `
    <div class="min-h-full w-full overflow-x-hidden">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-10 space-y-6">

        <!-- Header Card -->
        <div class="glass-effect rounded-[2.5rem] shadow-soft-xl p-5 sm:p-7 flex items-center justify-between gap-4 relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-400 to-purple-500"></div>

          <div class="flex items-center gap-4 min-w-0">
            <div class="w-14 h-14 sm:w-16 sm:h-16 rounded-2xl bg-white/80 border border-white/60 shadow-sm flex items-center justify-center shrink-0">
              <img src="https://img5.pic.in.th/file/secure-sv1/LOGO-SAPA-1.png" alt="LOGO" class="h-10 w-auto sm:h-12 object-contain"/>
            </div>
            <div class="min-w-0">
              <p class="text-xl sm:text-2xl font-extrabold text-gray-900 truncate">${currentUser.name || currentUser.username}</p>
              <p class="text-sm sm:text-base font-bold text-gray-600 truncate">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå <span class="font-extrabold ${levelColor === 'purple' ? 'text-purple-600' : 'text-orange-600'}">${levelLabel}</span></p>
            </div>
          </div>

          <button onclick="logout()" class="btn-secondary px-5 py-3 rounded-2xl font-extrabold text-sm sm:text-base shrink-0">
            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>
        </div>

        <!-- Queue Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div class="glass-effect rounded-[2.5rem] shadow-soft-xl p-6 sm:p-8 relative overflow-hidden">
            <div class="absolute -right-10 -top-10 w-40 h-40 bg-purple-100 rounded-full opacity-60"></div>
            <div class="relative z-10">
              <h3 class="text-xl font-extrabold text-purple-700 mb-4">‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏°.‡∏ï‡πâ‡∏ô</h3>
              <div class="flex items-end justify-between gap-4">
                <div class="text-6xl sm:text-7xl font-extrabold text-purple-700 tabular-nums" id="liveCurrentJuniorQueue">${currentJuniorQueue}</div>
                <span class="px-4 py-2 rounded-full bg-purple-100 text-purple-700 font-bold text-sm sm:text-base">‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á (Admin ‡∏Ñ‡∏∏‡∏°)</span>
              </div>
            </div>
          </div>

          <div class="glass-effect rounded-[2.5rem] shadow-soft-xl p-6 sm:p-8 relative overflow-hidden">
            <div class="absolute -right-10 -top-10 w-40 h-40 bg-orange-100 rounded-full opacity-60"></div>
            <div class="relative z-10">
              <h3 class="text-xl font-extrabold text-orange-700 mb-4">‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏°.‡∏õ‡∏•‡∏≤‡∏¢</h3>
              <div class="flex items-end justify-between gap-4">
                <div class="text-6xl sm:text-7xl font-extrabold text-orange-700 tabular-nums" id="liveCurrentSeniorQueue">${currentSeniorQueue}</div>
                <span class="px-4 py-2 rounded-full bg-orange-100 text-orange-700 font-bold text-sm sm:text-base">‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á (Admin ‡∏Ñ‡∏∏‡∏°)</span>
              </div>
            </div>
          </div>
        </div>

        <!-- List -->
        <div class="glass-effect rounded-[2.5rem] shadow-soft-xl p-5 sm:p-7">
          <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-5">
            <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900">
              ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå <span class="${levelColor === 'purple' ? 'text-purple-700' : 'text-orange-700'}">${levelLabel}</span>
            </h2>
            <div class="flex items-center gap-2 text-sm text-gray-500 font-bold">
              <span class="inline-flex items-center gap-2"><span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span>‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
              <span class="inline-flex items-center gap-2"><span class="w-2.5 h-2.5 bg-gray-400 rounded-full"></span>‡∏£‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
            </div>
          </div>

          <div class="w-full overflow-x-auto rounded-2xl border border-gray-100 bg-white/60">
            <table class="min-w-[980px] w-full text-left">
              <thead class="bg-white">
                <tr class="text-gray-700">
                  <th class="px-4 py-4 font-extrabold">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
                  <th class="px-4 py-4 font-extrabold">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th class="px-4 py-4 font-extrabold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©</th>
                  <th class="px-4 py-4 font-extrabold text-center">‡∏Ñ‡∏ì‡∏¥‡∏ï</th>
                  <th class="px-4 py-4 font-extrabold text-center">‡∏ß‡∏¥‡∏ó‡∏¢‡πå</th>
                  <th class="px-4 py-4 font-extrabold text-center">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</th>
                  <th class="px-4 py-4 font-extrabold text-center">‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</th>
                  <th class="px-4 py-4 font-extrabold text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå</th>
                  <th class="px-4 py-4 font-extrabold text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th class="px-4 py-4 font-extrabold text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody>
                ${list.map((s, idx) => {
                  const myScore = getInterviewScores(s)?.[currentUser.username]?.total;
                  const interviewScoreTxt = (myScore !== undefined) ? String(myScore) : '-';
                  return `
                    <tr class="border-t border-gray-100 hover:bg-orange-50/40 transition-colors">
                      <td class="px-4 py-4 font-bold text-gray-700">${s.interview_order || (idx+1)}</td>
                      <td class="px-4 py-4">
                        <div class="font-extrabold text-gray-900">${s.name}</div>
                        <div class="text-xs text-gray-500 font-bold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏≠‡∏ö: ${s.exam_number || '-'}</div>
                      </td>
                      <td class="px-4 py-4 text-gray-700 font-bold">${(s.ability || '-')}</td>
                      <td class="px-4 py-4 text-center font-extrabold">${s.math_score || 0}</td>
                      <td class="px-4 py-4 text-center font-extrabold">${s.science_score || 0}</td>
                      <td class="px-4 py-4 text-center font-extrabold">${s.english_score || 0}</td>
                      <td class="px-4 py-4 text-center font-extrabold">${s.total_score || 0}</td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center px-3 py-1.5 rounded-full bg-gray-100 text-gray-700 font-extrabold">
                          ${interviewScoreTxt}
                        </span>
                      </td>
                      <td class="px-4 py-4 text-center">${statusPill(s)}</td>
                      <td class="px-4 py-4 text-center">${scoreBtn(s)}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <div class="mt-6">
            <h3 class="text-lg font-extrabold text-gray-800 mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
            <div id="committee-history" class="bg-white/70 border border-gray-100 rounded-2xl p-4 sm:p-6">
              <p class="text-gray-400 text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>
            </div>
          </div>
        </div>

      </div>
    </div>
  `;

  renderCommitteeHistory();
  updateLiveUI(); // ensure queue numbers correct right away
}


    function renderCommitteeHistory() {
  const box = document.getElementById('committee-history');
  if (!box) return;

  const my = studentsData
    .filter(s => s.confirmed && hasCommitteeScored(s, currentUser.username))
    .sort((a,b) => Number(a.interview_order||999999) - Number(b.interview_order||999999));

  if (my.length === 0) {
    box.innerHTML = `<p class="text-gray-400 text-center text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>`;
    return;
  }

  box.innerHTML = `
    <div class="space-y-3">
      ${my.map(s => {
        const scores = getInterviewScores(s)?.[currentUser.username];
        return `
          <div class="border border-gray-100 rounded-2xl p-4 flex items-center justify-between bg-white">
            <div class="min-w-0">
              <p class="font-extrabold text-gray-900 truncate">${s.name} <span class="text-gray-400 font-bold">(#${s.interview_order || '-'})</span></p>
              <p class="text-sm text-gray-500 font-bold truncate">${s.current_school || '-'}</p>
            </div>
            <div class="text-right shrink-0">
              <p class="text-xs text-gray-400 font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</p>
              <p class="font-extrabold text-xl text-orange-600 tabular-nums">${scores?.total ?? '-'}</p>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

    function openScoreForm(studentId) {
      const student = studentsData.find(s => String(s.national_id) === String(studentId));
      if (!student) return;

      if (hasCommitteeScored(student, currentUser.username)) {
        showModal(`<div class="p-8 text-center"><p class="text-gray-800 font-bold text-xl mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p><p class="text-gray-600 mb-6">‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ</p><button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary text-white px-8 py-3 rounded-xl font-medium">‡∏ï‡∏Å‡∏•‡∏á</button></div>`);
        return;
      }

      showModal(`
        <div class="p-6 md:p-10">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 leading-tight">${student.name}</h2>
              <div class="flex items-center gap-3 mt-2">${getLevelBadge(student.level)} <span class="text-gray-500 font-medium">#${student.exam_number || '-'}</span></div>
            </div>
            <div class="text-right">
              <p class="text-sm font-bold text-gray-500">‡∏Ñ‡∏¥‡∏ß</p>
              <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center font-extrabold text-4xl">${student.interview_order || '-'}</div>
            </div>
          </div>

          <form id="scoreForm" class="space-y-5">
            <div class="bg-blue-50 border border-blue-100 p-4 rounded-2xl text-blue-800 font-medium">
              ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
            </div>

            ${[
              {id:1, title:'1) ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (20)', options:[20,15,10,5]},
              {id:2, title:'2) ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡∏ï‡∏Ñ‡∏ï‡∏¥ (20)', options:[20,15,10,5]},
              {id:3, title:'3) ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ (30)', options:[30,25,20,15,10]},
              {id:4, title:'4) ‡∏ó‡∏±‡∏®‡∏ô‡∏Ñ‡∏ï‡∏¥‡∏ï‡πà‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ (30)', options:[30,25,20,15,10]},
            ].map(c => `
              <div class="bg-white border-2 border-gray-100 p-5 rounded-[1.5rem]">
                <label class="block text-lg font-bold text-gray-900 mb-3">${c.title}</label>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  ${c.options.map(opt => `
                    <label class="cursor-pointer">
                      <input type="radio" name="score${c.id}" value="${opt}" class="peer hidden" required>
                      <div class="peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500 bg-white border-2 border-gray-200 text-gray-700 font-bold text-center py-3 rounded-xl transition-all hover:bg-orange-50">
                        ${opt}
                      </div>
                    </label>
                  `).join('')}
                </div>
              </div>
            `).join('')}

            <div class="flex gap-4 pt-2">
              <button type="button" onclick="closeModal(this.closest('.modal-overlay'))" class="btn-secondary flex-1 px-6 py-4 rounded-2xl font-bold text-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="btn-primary flex-1 text-white px-6 py-4 rounded-2xl font-bold text-lg shadow-glow-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </div>
          </form>
        </div>
      `);

      document.getElementById('scoreForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitScore(studentId);
      });
    }

    async function submitScore(studentId) {
      const s1 = document.querySelector('input[name="score1"]:checked')?.value;
      const s2 = document.querySelector('input[name="score2"]:checked')?.value;
      const s3 = document.querySelector('input[name="score3"]:checked')?.value;
      const s4 = document.querySelector('input[name="score4"]:checked')?.value;
      if (!s1 || !s2 || !s3 || !s4) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠"); return; }

      // ‡∏õ‡∏¥‡∏î modal ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏ä‡∏ß‡πå progress
      const scoreModal = document.querySelector('.modal-overlay');
      if (scoreModal) closeModal(scoreModal);

      const loadingModal = showLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...');

      try {
        const payload = {
          action: 'submitScore',
          studentId: String(studentId),
          committeeName: currentUser.username,
          totalScore: (parseInt(s1,10)+parseInt(s2,10)+parseInt(s3,10)+parseInt(s4,10)),
          score1: parseInt(s1,10),
          score2: parseInt(s2,10),
          score3: parseInt(s3,10),
          score4: parseInt(s4,10),
        };

        const res = await fetchJSON(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });

        closeModal(loadingModal);

        if (res?.status === 'error') {
          showModal(`<div class="text-center py-10">
            <p class="text-xl font-extrabold text-red-600 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
            <p class="text-gray-600 mb-6">${res.message || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'}</p>
            <button class="btn-primary text-white px-8 py-3 rounded-xl font-bold" onclick="closeModal(this.closest('.modal-overlay'))">‡∏ï‡∏Å‡∏•‡∏á</button>
          </div>`);
          return;
        }

        showModal(`<div class="text-center py-10">
          <p class="text-2xl font-extrabold text-green-600 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
          <p class="text-gray-600 mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
          <button class="btn-primary text-white px-8 py-3 rounded-xl font-bold" onclick="closeModal(this.closest('.modal-overlay'))">‡∏õ‡∏¥‡∏î</button>
        </div>`);

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
        initAPI(true);

      } catch (err) {
        closeModal(loadingModal);
        showModal(`<div class="text-center py-10">
          <p class="text-xl font-extrabold text-red-600 mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
          <p class="text-gray-600 mb-6">${err?.message || err}</p>
          <button class="btn-primary text-white px-8 py-3 rounded-xl font-bold" onclick="closeModal(this.closest('.modal-overlay'))">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>`);
      }
    }

    // ============================================================
    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô / 8 ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô 100)
    // ============================================================
    function calcInterviewFinal(student) {
      const scoresObj = getInterviewScores(student); // {judge:{score1..4}}
      const judges = Object.values(scoresObj || {});
      const sum = { s1:0, s2:0, s3:0, s4:0 };

      for (const j of judges) {
        sum.s1 += Number(j.score1 || 0);
        sum.s2 += Number(j.score2 || 0);
        sum.s3 += Number(j.score3 || 0);
        sum.s4 += Number(j.score4 || 0);
      }

      const a1 = sum.s1 / TOTAL_JUDGES;
      const a2 = sum.s2 / TOTAL_JUDGES;
      const a3 = sum.s3 / TOTAL_JUDGES;
      const a4 = sum.s4 / TOTAL_JUDGES;
      const total100 = a1 + a2 + a3 + a4;

      return { judgeCount: judges.length, a1, a2, a3, a4, total100 };
    }

    // ============================================================
    // Admin Dashboard + Queue Manager (‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á)
    // ============================================================
    let currentQueueLevel = null;

    function renderAdminDashboard() {
      startAutoRefresh();

      document.getElementById('app').innerHTML = `
        <div class="min-h-full p-4 md:p-8 bg-gray-900 text-white">
          <div class="max-w-6xl mx-auto space-y-8">

            <div class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
              <div>
                <h1 class="text-3xl font-bold">Admin Control Panel</h1>
                <p class="text-gray-400">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö: ${currentUser.name || currentUser.username}</p>
              </div>
              <button onclick="logout()" class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-xl transition-all">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-gray-800 rounded-3xl p-6 border-l-4 border-purple-500">
                <h2 class="text-xl text-purple-300 font-bold mb-2">‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á ‡∏°.‡∏ï‡πâ‡∏ô</h2>
                <p id="liveAdminJunior" class="text-6xl font-extrabold">${(queueState.junior ?? '-') || '-'}</p>
              </div>
              <div class="bg-gray-800 rounded-3xl p-6 border-l-4 border-orange-500">
                <h2 class="text-xl text-orange-300 font-bold mb-2">‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á ‡∏°.‡∏õ‡∏•‡∏≤‡∏¢</h2>
                <p id="liveAdminSenior" class="text-6xl font-extrabold">${(queueState.senior ?? '-') || '-'}</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
              <button onclick="openQueueManager()" class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 p-8 rounded-[2rem] text-left transition-all shadow-lg">
                <h3 class="text-2xl font-bold">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß / ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß</h3>
                <p class="text-blue-100">‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞ sync ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
              </button>

              <button onclick="showAdminScores()" class="bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 p-8 rounded-[2rem] text-left transition-all shadow-lg">
                <h3 class="text-2xl font-bold">‡∏î‡∏π‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</h3>
                <p class="text-emerald-100">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function openQueueManager() {
      showModal(`
        <div class="p-6 md:p-10 text-center">
          <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 mb-8">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <button onclick="showQueueLevel('junior')" class="bg-gradient-to-br from-purple-500 to-purple-700 text-white p-10 rounded-[2rem] shadow-lg">
              <h3 class="text-3xl font-extrabold">‡∏°.‡∏ï‡πâ‡∏ô</h3>
            </button>
            <button onclick="showQueueLevel('senior')" class="bg-gradient-to-br from-orange-500 to-orange-700 text-white p-10 rounded-[2rem] shadow-lg">
              <h3 class="text-3xl font-extrabold">‡∏°.‡∏õ‡∏•‡∏≤‡∏¢</h3>
            </button>
          </div>
          <button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-secondary w-full px-6 py-4 rounded-2xl font-bold text-lg">‡∏õ‡∏¥‡∏î</button>
        </div>
      `);
    }

    function showQueueLevel(level) {
      currentQueueLevel = level;

      const curStudent = getCurrentStudentByLevel(level);
      if (!curStudent) {
        showModal(`<div class="p-8 text-center"><p class="text-gray-800 font-bold text-xl mb-6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏µ‡πâ</p><button onclick="closeModal(this.closest('.modal-overlay')); openQueueManager();" class="btn-primary text-white px-8 py-3 rounded-xl font-medium">‡∏ï‡∏Å‡∏•‡∏á</button></div>`);
        return;
      }
      renderQueueManager();
    }

    function renderQueueManager() {
      const cur = getCurrentStudentByLevel(currentQueueLevel);
      const skipped = studentsData
        .filter(s => s.level === currentQueueLevel && s.confirmed && s.is_skipped)
        .sort((a,b) => num(a.interview_order, 999999) - num(b.interview_order, 999999));

      document.querySelectorAll('.modal-overlay').forEach(m => closeModal(m));

      showModal(`
        <div class="p-6 md:p-10">
          <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100">
            <div>
              <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå</h2>
              <p class="text-gray-500 mt-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: ${getLevelBadge(currentQueueLevel)}</p>
            </div>
            <div class="text-right">
              <p class="text-sm font-bold text-gray-400">‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
              <p class="text-4xl font-extrabold">${getQueueNow(currentQueueLevel) || '-'}</p>
            </div>
          </div>

          ${cur ? `
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
              <div class="md:col-span-2 bg-gradient-to-br from-orange-500 to-orange-600 rounded-[2rem] p-6 text-white text-center shadow-lg">
                <p class="text-lg font-bold mb-1 opacity-90">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå‡∏Ñ‡∏¥‡∏ß</p>
                <p class="text-7xl font-extrabold leading-none mb-2">${cur.interview_order || '-'}</p>
                <div class="bg-white/20 rounded-xl p-3 backdrop-blur-sm">
                  <p class="text-lg font-bold truncate">${cur.name}</p>
                </div>
              </div>

              <div class="md:col-span-3 bg-gray-50 border-2 border-gray-100 rounded-[2rem] p-6">
                <h3 class="text-xl font-extrabold text-gray-900 mb-2">${cur.name}</h3>
                <p class="text-gray-600 mb-4">${cur.current_school || '-'} | ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏≠‡∏ö: ${cur.exam_number || '-'}</p>

                <div class="flex flex-wrap gap-2">
                  <span class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold">‡∏Ñ‡∏ì‡∏¥‡∏ï: ${cur.math_score || 0}</span>
                  <span class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-bold">‡∏ß‡∏¥‡∏ó‡∏¢‡πå: ${cur.science_score || 0}</span>
                  <span class="px-4 py-2 bg-pink-100 text-pink-700 rounded-lg font-bold">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©: ${cur.english_score || 0}</span>
                  <span class="px-4 py-2 bg-gray-800 text-white rounded-lg font-bold">‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô: ${cur.total_score || 0}</span>
                </div>
              </div>
            </div>
          ` : `<div class="p-10 text-center text-gray-500">‡∏´‡∏°‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</div>`}

          ${skipped.length > 0 ? `
            <div class="bg-yellow-50 border-2 border-yellow-100 rounded-[1.5rem] p-5 mb-6">
              <h3 class="font-bold text-yellow-800 mb-3 text-lg">‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥ (${skipped.length} ‡∏Ñ‡∏ô)</h3>
              <div class="flex flex-wrap gap-3">
                ${skipped.map(s => `
                  <div class="bg-white border border-yellow-200 rounded-xl p-2 pr-4 flex items-center gap-3 shadow-sm">
                    <span class="w-10 h-10 bg-yellow-100 text-yellow-700 rounded-lg flex items-center justify-center font-bold">${s.interview_order || '-'}</span>
                    <span class="font-medium text-gray-800 truncate max-w-[150px]">${s.name}</span>
                    <button onclick="recallStudent('${s.national_id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-bold">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</button>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="flex gap-3">
            <button onclick="skipQueueCentral()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-4 rounded-2xl font-bold text-lg">‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß (Skip)</button>
            <button onclick="nextQueueCentral()" class="flex-[2] btn-primary text-white px-6 py-4 rounded-2xl font-bold text-lg shadow-glow-primary">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
          </div>

          <button onclick="openQueueManager()" class="btn-secondary w-full mt-4 px-6 py-3 rounded-2xl font-bold">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
      `);
    }

    async function nextQueueCentral() {
      const loading = showLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ...');
      try {
        const res = await queueNext(currentQueueLevel);
        closeModal(loading);
        if (res?.status === 'error') throw new Error(res.message || 'queueNext error');
        await initAPI(true);
        renderQueueManager();
      } catch (e) {
        closeModal(loading);
        showModal(`<div class="p-8 text-center">
          <p class="text-red-600 font-bold text-xl mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
          <p class="text-gray-600 mb-6">${e?.message || e}</p>
          <button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary text-white px-8 py-3 rounded-xl font-bold">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>`);
      }
    }

    async function skipQueueCentral() {
      const loading = showLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß...');
      try {
        const res = await queueSkip(currentQueueLevel);
        closeModal(loading);
        if (res?.status === 'error') throw new Error(res.message || 'queueSkip error');
        await initAPI(true);
        renderQueueManager();
      } catch (e) {
        closeModal(loading);
        showModal(`<div class="p-8 text-center">
          <p class="text-red-600 font-bold text-xl mb-2">‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
          <p class="text-gray-600 mb-6">${e?.message || e}</p>
          <button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary text-white px-8 py-3 rounded-xl font-bold">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>`);
      }
    }

    async function recallStudent(studentId) {
      const student = studentsData.find(s => String(s.national_id) === String(studentId));
      if (!student) return;

      const loading = showLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß...');
      try {
        await saveData(student.national_id, { is_skipped: false });
        closeModal(loading);
        await initAPI(true);
        renderQueueManager();
      } catch (e) {
        closeModal(loading);
        showModal(`<div class="p-8 text-center">
          <p class="text-red-600 font-bold text-xl mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
          <p class="text-gray-600 mb-6">${e?.message || e}</p>
          <button onclick="closeModal(this.closest('.modal-overlay'))" class="btn-primary text-white px-8 py-3 rounded-xl font-bold">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>`);
      }
    }

    function showAdminScores() {
      renderScoreSummary();
    }

    function renderScoreSummary() {
      const allConfirmedStudents = studentsData
        .filter(s => s.confirmed)
        .sort((a,b) => num(a.interview_order, 999999) - num(b.interview_order, 999999));

      document.getElementById('app').innerHTML = `
        <div class="min-h-full p-6 md:p-10 bg-gray-900 text-white">
          <div class="max-w-5xl mx-auto space-y-6">
            <div class="flex items-center justify-between">
              <h1 class="text-3xl font-extrabold">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå</h1>
              <button onclick="renderAdminDashboard()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>

            <div class="space-y-3">
              ${allConfirmedStudents.map(s => {
                const scoresObj = getInterviewScores(s);
                const count = Object.keys(scoresObj || {}).length;
                const fin = calcInterviewFinal(s);
                return `
                  <div class="bg-gray-800 rounded-2xl p-4 flex items-center justify-between gap-4">
                    <div class="min-w-0">
                      <p class="font-bold text-lg truncate">${s.name} <span class="text-gray-400 font-normal">(#${s.interview_order || '-'})</span></p>
                      <p class="text-sm text-gray-400 truncate">${s.current_school || '-'}</p>
                    </div>
                    <div class="text-right shrink-0">
                      <p class="text-sm text-gray-400">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                      <p class="text-2xl font-extrabold text-orange-300">${count}/8</p>
                      <p class="text-sm text-gray-400 mt-1">‡∏£‡∏ß‡∏°‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/8)</p>
                      <p class="text-xl font-extrabold text-emerald-300">${fin.total100.toFixed(2)}</p>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // ============================================================
    // Render Current View (‡πÄ‡∏°‡∏∑‡πà‡∏≠ refresh ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà)
    // ============================================================
    function renderCurrentView() {
      if (!currentUser) return;
      if (currentUser.user_type === 'student') renderStudentDashboard();
      else if (currentUser.user_type === 'admin') renderAdminDashboard();
      else renderCommitteeDashboard();
    }

    // ============================================================
    // Logout
    // ============================================================
    function logout() {
      stopAutoRefresh();
      currentUser = null;
      clearSession();
      renderLoginPage();
    }

    // ============================================================
    // ‚úÖ Main Init
    // ============================================================
    async function init() {
      await initAPI(false);

      const sess = loadSession();
      if (!sess) return;

      if (sess.type === 'student') {
        const st = studentsData.find(s => String(s.national_id) === String(sess.id));
        if (st) {
          currentUser = { ...st, user_type: 'student' };
          renderStudentDashboard();
        }
      } else if (sess.type === 'committee') {
        const u = committeesData.find(c => String(c.username) === String(sess.username) && String(c.password) === String(sess.password));
        if (u) {
          currentUser = u;
          if (u.user_type === 'admin') renderAdminDashboard();
          else renderCommitteeDashboard();
        }
      }
    }
    window.onload = init;
  </script>
</body>
</html>
