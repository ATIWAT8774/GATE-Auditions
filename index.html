<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ระบบยืนยันสิทธิ์ / สัมภาษณ์</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:50;padding:16px}
    .modal{background:#fff;border-radius:24px;max-width:720px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    .btn{border-radius:16px;padding:12px 16px;font-weight:800}
    .btn-primary{background:#16a34a;color:#fff}
    .btn-danger{background:#dc2626;color:#fff}
    .btn-gray{background:#111827;color:#fff}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:24px;padding:18px}
    .label{font-weight:800;color:#374151}
    .input{width:100%;border:1px solid #e5e7eb;border-radius:16px;padding:12px 14px;outline:none}
    .input:focus{border-color:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.15)}
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-4 md:p-8">
    <header class="flex items-start justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold">ระบบยืนยันสิทธิ์ / สัมภาษณ์</h1>
        <p class="text-gray-600 font-semibold">อัปเดตอัตโนมัติ ลด Server Busy แล้ว</p>
      </div>
      <div class="text-right">
        <div id="serverTime" class="text-sm text-gray-500 font-bold"></div>
        <button id="btnLogout" class="btn btn-gray hidden mt-2" onclick="logout()">ออกจากระบบ</button>
      </div>
    </header>

    <main id="app" class="space-y-4"></main>

    <footer class="mt-10 text-center text-gray-500 text-sm font-semibold">
      © ระบบตัวอย่าง (แก้ให้รองรับการใช้งานพร้อมกัน)
    </footer>
  </div>

<script>
/******************************
 *  CONFIG (แก้ API_URL)
 ******************************/
const API_URL = "PUT_YOUR_GAS_WEBAPP_EXEC_URL_HERE"; // เช่น https://script.google.com/macros/s/xxxxx/exec หรือ /api/gas

const AUTO_REFRESH_MS = 12000; // ✅ ลดความถี่
let autoRefreshInterval = null;

let syncPaused = false; // ✅ พัก auto refresh ตอนกำลังบันทึก
let studentsData = [];
let queueState = { junior:{}, senior:{} };

let currentUser = null; // {user_type:"student"/"committee"/"admin", ...}
let uploadedAudio = null; // {fileData, mimeType, fileName}
let queueBusy = false;
let currentQueueLevel = "junior";

/******************************
 *  UI HELPERS
 ******************************/
function $(id){ return document.getElementById(id); }

function showModal(html) {
  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = `<div class="modal">${html}</div>`;
  document.body.appendChild(overlay);
  return overlay;
}

function closeModal(overlay) {
  if (!overlay) return;
  overlay.remove();
}

function showLoadingModal(text) {
  return showModal(`
    <div class="p-8 text-center">
      <div class="animate-spin mx-auto w-10 h-10 rounded-full border-4 border-gray-200 border-t-green-500 mb-4"></div>
      <div class="font-extrabold text-gray-800">${escapeHtml(text || "กำลังทำงาน...")}</div>
      <div class="text-gray-500 font-semibold mt-1">กรุณารอสักครู่</div>
    </div>
  `);
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/******************************
 *  NETWORK
 ******************************/
async function fetchJSON(url, options = {}, timeoutMs = 12000) {
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const res = await fetch(url, { ...options, signal: controller.signal });
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); }
    catch { data = text; }
    return data;
  } finally {
    clearTimeout(t);
  }
}

/******************************
 *  DATA LOAD
 ******************************/
function startAutoRefresh() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval = setInterval(() => {
    if (syncPaused) return;
    initAPI(true);
  }, AUTO_REFRESH_MS);
}

async function initAPI(silent = false) {
  const loading = !silent ? showLoadingModal("กำลังดึงข้อมูล...") : null;

  let lastErr = null;
  for (let i = 0; i < 3; i++) {
    try {
      const data = await fetchJSON(API_URL + "?t=" + Date.now(), {}, 12000);

      // ✅ ถ้า server ส่ง error object อย่าทำให้ข้อมูลกลายเป็น []
      if (data && typeof data === "object" && data.status === "error") {
        throw new Error(data.message || "Server Busy");
      }

      onDataLoaded(data, { silent, loading });
      return;
    } catch (e) {
      lastErr = e;
      await new Promise(r => setTimeout(r, 600 * (i + 1)));
    }
  }
  onDataError(lastErr, { silent, loading });
}

function onDataLoaded(api, ctx) {
  if (ctx.loading) closeModal(ctx.loading);

  if (!api || api.status !== "ok") {
    if (!ctx.silent) renderError("ข้อมูลไม่ถูกต้อง");
    return;
  }

  studentsData = Array.isArray(api.students) ? api.students : [];
  queueState = api.queue || queueState;

  $("serverTime").textContent = api.serverTime ? `Server: ${api.serverTime}` : "";
  updateLiveUI();

  // ถ้าไม่ login ให้หน้าล็อกอิน
  if (!currentUser) {
    renderLogin();
    return;
  }

  // update currentUser จากข้อมูลล่าสุด (เฉพาะนักเรียน)
  if (currentUser.user_type === "student") {
    const id = String(currentUser.national_id || currentUser.student_id || currentUser._id || "");
    const fresh = studentsData.find(s =>
      String(s.national_id || "") === id ||
      String(s.student_id || "") === id ||
      String(s._id || "") === id
    );
    if (fresh) currentUser = { ...fresh, user_type: "student" };
    renderStudentDashboard();
    return;
  }

  if (currentUser.user_type === "committee" || currentUser.user_type === "admin") {
    renderCommitteeDashboard();
    return;
  }

  renderLogin();
}

function onDataError(err, ctx) {
  if (ctx.loading) closeModal(ctx.loading);
  if (!ctx.silent) renderError(err?.message || String(err));
}

/******************************
 *  APP RENDER
 ******************************/
function renderError(msg) {
  $("app").innerHTML = `
    <div class="card">
      <div class="text-red-600 font-extrabold text-xl">เกิดข้อผิดพลาด</div>
      <div class="text-gray-700 font-semibold mt-2">${escapeHtml(msg)}</div>
      <button class="btn btn-primary mt-4" onclick="initAPI(false)">ลองใหม่</button>
    </div>
  `;
}

function renderLogin() {
  $("btnLogout").classList.add("hidden");
  $("app").innerHTML = `
    <div class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h2 class="text-xl font-extrabold mb-3">เข้าสู่ระบบนักเรียน</h2>
        <div class="space-y-3">
          <div>
            <div class="label mb-1">เลขประจำตัว/เลขบัตร (ตามที่บันทึกในชีต)</div>
            <input id="studentId" class="input" placeholder="เช่น 1234567890123" />
          </div>
          <button class="btn btn-primary w-full" onclick="loginStudent()">เข้าสู่ระบบ</button>
        </div>
      </div>

      <div class="card">
        <h2 class="text-xl font-extrabold mb-3">เข้าสู่ระบบกรรมการ</h2>
        <div class="space-y-3">
          <div>
            <div class="label mb-1">ชื่อผู้ใช้</div>
            <input id="staffUser" class="input" placeholder="username" />
          </div>
          <div>
            <div class="label mb-1">รหัสผ่าน (ถ้ามี)</div>
            <input id="staffPass" type="password" class="input" placeholder="password" />
          </div>
          <button class="btn btn-gray w-full" onclick="loginStaff()">เข้าสู่ระบบ</button>
          <p class="text-gray-500 text-sm font-semibold">
            * ถ้าคุณไม่มีชีต users ระบบจะให้ผ่านแบบง่าย (เพื่อไม่ให้พัง)
          </p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="font-extrabold">สถานะระบบ</div>
      <div class="text-gray-600 font-semibold mt-1">นักเรียนทั้งหมด: ${studentsData.length}</div>
      <div class="text-gray-600 font-semibold">อัปเดตอัตโนมัติทุก ${Math.round(AUTO_REFRESH_MS/1000)} วินาที</div>
    </div>
  `;
}

async function loginStudent() {
  const id = $("studentId").value.trim();
  if (!id) return alert("กรุณากรอกเลขประจำตัว/เลขบัตร");

  const loading = showLoadingModal("กำลังเข้าสู่ระบบ...");
  try {
    const res = await fetchJSON(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action: "login", user_type: "student", id })
    }, 20000);

    closeModal(loading);
    if (res?.status !== "ok") throw new Error(res?.message || "เข้าสู่ระบบไม่สำเร็จ");

    currentUser = res.user;
    $("btnLogout").classList.remove("hidden");
    renderStudentDashboard();
  } catch (e) {
    closeModal(loading);
    alert(e?.message || e);
  }
}

async function loginStaff() {
  const username = $("staffUser").value.trim();
  const password = $("staffPass").value.trim();
  if (!username) return alert("กรุณากรอกชื่อผู้ใช้");

  const loading = showLoadingModal("กำลังเข้าสู่ระบบ...");
  try {
    const res = await fetchJSON(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action: "login", user_type: "committee", username, password })
    }, 20000);

    closeModal(loading);
    if (res?.status !== "ok") throw new Error(res?.message || "เข้าสู่ระบบไม่สำเร็จ");

    currentUser = res.user;
    $("btnLogout").classList.remove("hidden");
    renderCommitteeDashboard();
  } catch (e) {
    closeModal(loading);
    alert(e?.message || e);
  }
}

function logout() {
  currentUser = null;
  uploadedAudio = null;
  renderLogin();
}

/******************************
 *  STUDENT DASHBOARD
 ******************************/
function renderStudentDashboard() {
  if (!currentUser) return renderLogin();

  const id = currentUser.national_id || currentUser.student_id || currentUser._id || "-";
  const name = currentUser.name || currentUser.fullname || currentUser.student_name || "";
  const status = currentUser.status || "-";
  const confirmed = (String(currentUser.confirmed).toLowerCase() === "true" || currentUser.confirmed === true);
  const declined = (String(currentUser.declined).toLowerCase() === "true" || currentUser.declined === true);

  $("app").innerHTML = `
    <div class="card">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl font-extrabold">ข้อมูลนักเรียน</div>
          <div class="text-gray-700 font-bold mt-1">${escapeHtml(name)} <span class="text-gray-500 font-semibold">(${escapeHtml(id)})</span></div>
          <div class="text-gray-600 font-semibold mt-1">สถานะ: <span class="font-extrabold text-gray-900">${escapeHtml(status)}</span></div>
          <div class="text-gray-600 font-semibold">ยืนยันสิทธิ์: <span class="font-extrabold ${confirmed ? "text-green-600":"text-red-600"}">${confirmed ? "แล้ว":"ยังไม่ยืนยัน"}</span></div>
          <div class="text-gray-600 font-semibold">สละสิทธิ์: <span class="font-extrabold ${declined ? "text-red-600":"text-gray-900"}">${declined ? "สละสิทธิ์แล้ว":"-"}</span></div>
        </div>
        <div class="text-right">
          <div class="text-gray-600 font-semibold">ลำดับสัมภาษณ์</div>
          <div class="text-3xl font-extrabold">${escapeHtml(currentUser.interview_order || "-")}</div>
          <div class="text-gray-600 font-semibold mt-1">ช่วงเวลา</div>
          <div class="font-extrabold">${escapeHtml(currentUser.interview_time || "-")}</div>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <div class="text-lg font-extrabold mb-2">กรอกความสามารถพิเศษ</div>
        <div class="text-gray-600 font-semibold mb-3">พิมพ์ให้สั้น กระชับ และตรงประเด็น</div>
        <textarea id="ability" class="input" rows="4" placeholder="เช่น ร้องเพลง / วาดรูป / เล่นกีฬา...">${escapeHtml(currentUser.ability || "")}</textarea>

        <div class="mt-3 flex flex-wrap gap-2">
          <button class="btn btn-primary" onclick="submitAbilityForm()">บันทึก + ยืนยันสิทธิ์</button>
          <button class="btn btn-gray" onclick="openAudioModal()">อัปโหลดไฟล์เสียง (ถ้ามี)</button>
        </div>
        <div class="text-sm text-gray-500 font-semibold mt-3">* ระบบจะพยายามบันทึกแบบกันล่มและ retry อัตโนมัติ</div>
      </div>

      <div class="card">
        <div class="text-lg font-extrabold mb-2">การสละสิทธิ์</div>
        <div class="text-gray-600 font-semibold mb-3">
          หากไม่ต้องการเข้าร่วม ให้กดสละสิทธิ์ ระบบจะบันทึกในชีตทันที
        </div>
        <button class="btn btn-danger w-full" onclick="declineRight()">สละสิทธิ์</button>
        <div class="text-xs text-gray-500 font-semibold mt-3">
          * จะตั้งค่า declined=true และ status="สละสิทธิ์" (ถ้าคอลัมน์มีในชีต)
        </div>
      </div>
    </div>
  `;
}

async function saveData(rowId, dataToUpdate, timeoutMs = 60000) {
  const id = String(rowId || "").trim();
  if (!id) throw new Error("Missing rowId");

  // optimistic update
  const idx = studentsData.findIndex(d =>
    String(d.national_id) === id || String(d.student_id) === id || String(d._id) === id
  );
  if (idx !== -1) studentsData[idx] = { ...studentsData[idx], ...dataToUpdate };
  if (currentUser && currentUser.user_type === "student" && String(currentUser.national_id || currentUser.student_id || currentUser._id) === id) {
    currentUser = { ...currentUser, ...dataToUpdate };
  }

  const payload = JSON.stringify({ id: id, data: dataToUpdate });

  // ✅ retry เวลา server busy
  for (let i = 0; i < 4; i++) {
    const res = await fetchJSON(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: payload
    }, timeoutMs);

    if (res && typeof res === "object" && res.status === "error") {
      const msg = String(res.message || "").toLowerCase();
      if (msg.includes("busy") || msg.includes("lock")) {
        await new Promise(r => setTimeout(r, 450 * (i + 1)));
        continue;
      }
      throw new Error(res.message || "update error");
    }

    return res;
  }

  throw new Error("ระบบกำลังใช้งานหนาแน่น กรุณาลองใหม่อีกครั้ง");
}

async function submitAbilityForm() {
  const ability = $("ability").value.trim();
  if (!ability) return alert("กรุณากรอกความสามารถพิเศษ");

  const loadingModal = showLoadingModal("กำลังบันทึกข้อมูล...");
  syncPaused = true;

  try {
    const patch = { ability, confirmed: true, status: "รอสัมภาษณ์" };
    if (uploadedAudio) {
      patch.fileData = uploadedAudio.fileData;
      patch.mimeType = uploadedAudio.mimeType;
      patch.fileName = uploadedAudio.fileName;
    }

    const id = currentUser.national_id || currentUser.student_id || currentUser._id;
    await saveData(id, patch);

    await initAPI(true); // ดึงข้อมูลล่าสุดกลับมา
    closeModal(loadingModal);

    showModal(`
      <div class="p-8 text-center">
        <div class="text-2xl font-extrabold text-green-600">บันทึกสำเร็จ</div>
        <div class="text-gray-700 font-semibold mt-2">ระบบยืนยันสิทธิ์และบันทึกความสามารถพิเศษแล้ว</div>
        <button class="btn btn-primary mt-6" onclick="closeModal(this.closest('.modal-overlay'))">ปิด</button>
      </div>
    `);
  } catch (e) {
    closeModal(loadingModal);
    alert(e?.message || e);
  } finally {
    syncPaused = false;
  }
}

function openAudioModal() {
  const overlay = showModal(`
    <div class="p-6 md:p-8">
      <div class="text-xl font-extrabold mb-2">อัปโหลดไฟล์เสียง</div>
      <div class="text-gray-600 font-semibold mb-4">รองรับ mp3/wav/m4a (ขนาดใหญ่เกินไปอาจช้า)</div>

      <input id="audioFile" type="file" accept="audio/*" class="input" />

      <div class="flex flex-wrap gap-2 mt-4">
        <button class="btn btn-primary" onclick="readAudioFile()">แนบไฟล์</button>
        <button class="btn btn-gray" onclick="closeModal(this.closest('.modal-overlay'))">ปิด</button>
      </div>

      <div id="audioInfo" class="text-sm text-gray-600 font-semibold mt-4"></div>
    </div>
  `);
  overlay.dataset.type = "audio";
}

async function readAudioFile() {
  const input = $("audioFile");
  if (!input.files || !input.files[0]) return alert("กรุณาเลือกไฟล์เสียง");

  const file = input.files[0];
  const info = document.querySelector("#audioInfo");
  info.textContent = "กำลังอ่านไฟล์...";

  const reader = new FileReader();
  reader.onload = () => {
    // dataURL => "data:audio/...;base64,xxxx"
    const dataUrl = reader.result;
    const parts = String(dataUrl).split(",");
    const meta = parts[0] || "";
    const base64 = parts[1] || "";

    const mimeMatch = meta.match(/data:(.*);base64/);
    const mimeType = mimeMatch ? mimeMatch[1] : "audio/*";

    uploadedAudio = { fileData: base64, mimeType, fileName: file.name };
    info.textContent = `แนบแล้ว: ${file.name}`;
  };
  reader.readAsDataURL(file);
}

async function declineRight() {
  if (!confirm("ยืนยันการสละสิทธิ์?")) return;

  const loading = showLoadingModal("กำลังบันทึกการสละสิทธิ์...");
  syncPaused = true;

  try {
    const id = currentUser.national_id || currentUser.student_id || currentUser._id;
    await saveData(id, { declined: true, status: "สละสิทธิ์" });
    await initAPI(true);
    closeModal(loading);

    showModal(`
      <div class="p-8 text-center">
        <div class="text-2xl font-extrabold text-red-600">สละสิทธิ์สำเร็จ</div>
        <div class="text-gray-700 font-semibold mt-2">ระบบบันทึกลงชีตแล้ว</div>
        <button class="btn btn-gray mt-6" onclick="closeModal(this.closest('.modal-overlay'))">ปิด</button>
      </div>
    `);
  } catch (e) {
    closeModal(loading);
    alert(e?.message || e);
  } finally {
    syncPaused = false;
  }
}

/******************************
 *  COMMITTEE DASHBOARD
 ******************************/
function renderCommitteeDashboard() {
  if (!currentUser) return renderLogin();

  $("app").innerHTML = `
    <div class="card">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <div class="text-xl font-extrabold">กรรมการ: ${escapeHtml(currentUser.username || "")}</div>
          <div class="text-gray-600 font-semibold">เลือกคิวและกด “คิวถัดไป” เพื่อเรียกผู้เข้าสัมภาษณ์</div>
        </div>
        <div class="flex gap-2">
          <button class="btn ${currentQueueLevel==="junior" ? "btn-primary":"btn-gray"}" onclick="setQueueLevel('junior')">คิว Junior</button>
          <button class="btn ${currentQueueLevel==="senior" ? "btn-primary":"btn-gray"}" onclick="setQueueLevel('senior')">คิว Senior</button>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <div class="text-lg font-extrabold mb-3">ควบคุมคิว (Central)</div>
        <div class="flex gap-2">
          <button class="btn btn-primary flex-1" onclick="nextQueueCentral()">คิวถัดไป</button>
          <button class="btn btn-danger flex-1" onclick="skipQueueCentral()">ข้ามคิว</button>
        </div>
        <div class="text-sm text-gray-500 font-semibold mt-3">
          * ระบบทำงานแบบล็อกคิวกลาง ลดปัญหากดพร้อมกัน
        </div>
      </div>

      <div class="card" id="currentCandidateCard">
        <!-- filled by updateLiveUI -->
      </div>
    </div>

    <div class="card">
      <div class="text-lg font-extrabold mb-3">ให้คะแนน (4 ข้อ)</div>

      <div class="grid md:grid-cols-2 gap-3">
        ${scoreBlock("1", "ความเหมาะสม / บุคลิกภาพ")}
        ${scoreBlock("2", "การสื่อสาร / มารยาท")}
        ${scoreBlock("3", "ความสามารถพิเศษ")}
        ${scoreBlock("4", "แรงจูงใจ / ความตั้งใจ")}
      </div>

      <div class="flex flex-wrap gap-2 mt-4">
        <button class="btn btn-primary" onclick="submitScoreFromUI()">บันทึกคะแนน</button>
        <button class="btn btn-gray" onclick="initAPI(false)">รีเฟรช</button>
      </div>
      <div class="text-sm text-gray-500 font-semibold mt-3">* ต้องมี “ผู้เข้าสัมภาษณ์ปัจจุบัน” ก่อนบันทึกคะแนน</div>
    </div>
  `;

  updateLiveUI();
}

function scoreBlock(n, title) {
  return `
    <div class="border border-gray-200 rounded-2xl p-4">
      <div class="font-extrabold mb-2">${escapeHtml(title)}</div>
      <div class="flex gap-2 flex-wrap">
        ${[1,2,3,4,5].map(v => `
          <label class="inline-flex items-center gap-2 px-3 py-2 border border-gray-200 rounded-xl font-bold cursor-pointer">
            <input type="radio" name="score${n}" value="${v}" />
            ${v}
          </label>
        `).join("")}
      </div>
    </div>
  `;
}

function setQueueLevel(level) {
  currentQueueLevel = level;
  renderCommitteeDashboard();
}

function getCurrentCandidateFromState() {
  // หลังจากกด next/skip เราจะเอา currentCandidate เก็บใน window._currentCandidate
  return window._currentCandidate || null;
}

function updateLiveUI() {
  // อัปเดตการ์ดผู้สัมภาษณ์ปัจจุบันสำหรับกรรมการ
  const card = document.querySelector("#currentCandidateCard");
  if (card && (currentUser?.user_type === "committee" || currentUser?.user_type === "admin")) {
    const c = getCurrentCandidateFromState();
    if (!c) {
      card.innerHTML = `
        <div class="text-lg font-extrabold mb-2">ผู้เข้าสัมภาษณ์ปัจจุบัน</div>
        <div class="text-gray-600 font-semibold">ยังไม่ได้เรียกคิว กด “คิวถัดไป”</div>
      `;
    } else {
      card.innerHTML = `
        <div class="text-lg font-extrabold mb-2">ผู้เข้าสัมภาษณ์ปัจจุบัน</div>
        <div class="font-extrabold text-gray-900">${escapeHtml(c.name || c.fullname || c.student_name || "-")}</div>
        <div class="text-gray-600 font-semibold mt-1">ID: ${escapeHtml(c.national_id || c.student_id || c._id || "-")}</div>
        <div class="text-gray-600 font-semibold">ความสามารถ: ${escapeHtml(c.ability || "-")}</div>
        <div class="text-gray-600 font-semibold">สถานะ: <span class="font-extrabold">${escapeHtml(c.status || "-")}</span></div>
        <div class="text-gray-600 font-semibold">ลำดับ: <span class="font-extrabold">${escapeHtml(c.interview_order || "-")}</span></div>
      `;
    }
  }
}

/******************************
 *  QUEUE API CALLS
 ******************************/
async function queueNext(level) {
  return fetchJSON(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action: "queueNext", level })
  }, 20000);
}
async function queueSkip(level) {
  return fetchJSON(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action: "queueSkip", level })
  }, 20000);
}

async function nextQueueCentral() {
  if (queueBusy) return;
  queueBusy = true;
  syncPaused = true;

  const level = (currentQueueLevel === "senior") ? "senior" : "junior";
  const loading = showLoadingModal("กำลังเลื่อนคิว...");
  try {
    const res = await queueNext(level);
    closeModal(loading);

    if (res?.status === "error") {
      showModal(`<div class="p-8 text-center">
        <p class="text-red-600 font-extrabold text-xl mb-2">เลื่อนคิวไม่สำเร็จ</p>
        <p class="text-gray-600 font-semibold mb-6">${escapeHtml(res.message || "กรุณาลองใหม่")}</p>
        <button class="btn btn-primary" onclick="closeModal(this.closest('.modal-overlay'))">ตกลง</button>
      </div>`);
      return;
    }

    window._currentCandidate = res.current || null;
    await initAPI(true);
    updateLiveUI();
  } catch (e) {
    closeModal(loading);
    alert(e?.message || e);
  } finally {
    queueBusy = false;
    syncPaused = false;
  }
}

async function skipQueueCentral() {
  if (queueBusy) return;
  queueBusy = true;
  syncPaused = true;

  const level = (currentQueueLevel === "senior") ? "senior" : "junior";
  const loading = showLoadingModal("กำลังข้ามคิว...");
  try {
    const res = await queueSkip(level);
    closeModal(loading);

    if (res?.status === "error") {
      showModal(`<div class="p-8 text-center">
        <p class="text-red-600 font-extrabold text-xl mb-2">ข้ามคิวไม่สำเร็จ</p>
        <p class="text-gray-600 font-semibold mb-6">${escapeHtml(res.message || "กรุณาลองใหม่")}</p>
        <button class="btn btn-primary" onclick="closeModal(this.closest('.modal-overlay'))">ตกลง</button>
      </div>`);
      return;
    }

    window._currentCandidate = res.current || null;
    await initAPI(true);
    updateLiveUI();
  } catch (e) {
    closeModal(loading);
    alert(e?.message || e);
  } finally {
    queueBusy = false;
    syncPaused = false;
  }
}

/******************************
 *  SUBMIT SCORE
 ******************************/
async function submitScoreFromUI() {
  const c = getCurrentCandidateFromState();
  if (!c) return alert("ยังไม่มีผู้เข้าสัมภาษณ์ปัจจุบัน");

  const s1 = document.querySelector('input[name="score1"]:checked')?.value;
  const s2 = document.querySelector('input[name="score2"]:checked')?.value;
  const s3 = document.querySelector('input[name="score3"]:checked')?.value;
  const s4 = document.querySelector('input[name="score4"]:checked')?.value;
  if (!s1 || !s2 || !s3 || !s4) return alert("กรุณาให้คะแนนให้ครบทุกข้อ");

  const loading = showLoadingModal("กำลังบันทึกคะแนน...");
  syncPaused = true;

  try {
    const studentId = c.national_id || c.student_id || c._id;
    const payload = {
      action: "submitScore",
      studentId: String(studentId),
      committeeName: currentUser.username,
      totalScore: (parseInt(s1,10)+parseInt(s2,10)+parseInt(s3,10)+parseInt(s4,10)),
      score1: parseInt(s1,10),
      score2: parseInt(s2,10),
      score3: parseInt(s3,10),
      score4: parseInt(s4,10)
    };

    const res = await fetchJSON(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    }, 30000);

    closeModal(loading);

    if (res?.status === "error") throw new Error(res.message || "บันทึกไม่สำเร็จ");

    showModal(`
      <div class="p-8 text-center">
        <div class="text-2xl font-extrabold text-green-600">บันทึกคะแนนสำเร็จ</div>
        <div class="text-gray-700 font-semibold mt-2">ระบบจะอัปเดตข้อมูลอัตโนมัติ</div>
        <button class="btn btn-primary mt-6" onclick="closeModal(this.closest('.modal-overlay'))">ปิด</button>
      </div>
    `);

    await initAPI(true);
  } catch (e) {
    closeModal(loading);
    alert(e?.message || e);
  } finally {
    syncPaused = false;
  }
}

/******************************
 *  INIT
 ******************************/
(function boot(){
  renderLogin();
  initAPI(true);
  startAutoRefresh();
})();
</script>
</body>
</html>
